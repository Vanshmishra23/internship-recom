const translations = {
  en: {
    brand: "PM Internship Scheme",
    "landing.tagline": "Find the internship that fits you best",
    "landing.cta": "Find My Internship",
    "landing.desc": "Discover curated opportunities across technology, finance, policy, healthcare and more. Tailored to your profile.",
    "card.students.title": "Students",
    "card.students.sub": "For undergrads & postgrads",
    "card.tech.title": "Tech-ready",
    "card.tech.sub": "Projects with real impact",
    "card.offices.title": "Offices & Remote",
    "card.offices.sub": "Government & private partners",

    "login.title": "Login / Signup",
    "field.fullname": "Full Name",
    "ph.fullname": "Enter your full name",
    "field.age": "Age",
    "ph.age": "18",
    "field.gender": "Gender",
    "opt.gender.select": "Select",
    "opt.gender.male": "Male",
    "opt.gender.female": "Female",
    "opt.gender.other": "Other",
    "field.location": "Location",
    "ph.location": "City, State",
    "field.phone": "Phone Number",
    "ph.phone": "+91 00000 00000",
    "field.aadhaar": "Aadhaar Number",
    "ph.aadhaar": "XXXX-XXXX-XXXX",
    "field.email": "Email (Optional)",
    "ph.email": "you@example.com",
    "btn.verify": "Verify & Continue",
    "btn.useLocation": "Use my location",
    "loc.noResults": "No results",
    "loc.permissionDenied": "Location permission denied",

    "edu.title": "Education Details",
    "edu.10": "10th % / Board / Year",
    "ph.edu.10": "e.g., 86% CBSE 2018",
    "edu.12": "12th % / Board / Year",
    "ph.edu.12": "e.g., 90% CBSE 2020",
    "edu.ug": "UG Degree / Branch / CGPA",
    "ph.edu.ug": "e.g., B.Tech CSE 8.2",
    "edu.pg": "PG Degree / Branch / CGPA",
    "ph.edu.pg": "e.g., M.Tech AI 8.8",
    "edu.extra": "Extra Qualifications",
    "ph.edu.extra": "Certifications, Courses, etc.",
    "edu.resume": "Upload Resume (PDF)",
    "edu.resume.hint": "PDF only, max 5 MB",
    "btn.next": "Next",

    "skills.title": "Select Your Skills",
    "skills.addPlaceholder": "Add a custom skill",
    "skills.add": "Add",
    "skills.minAlert": "Please select at least one skill.",
    "skills.js": "JavaScript",
    "skills.py": "Python",
    "skills.data": "Data Analysis",
    "skills.pm": "Project Management",
    "skills.policy": "Public Policy",
    "skills.health": "Healthcare",
    "skills.sustain": "Sustainability",
    "skills.teach": "Teaching",
    "skills.hr": "Human Resources",
    "skills.civil": "Civil Engineering",
    "skills.rural": "Rural Outreach",

    "btn.continue": "Continue",

    "rec.title": "Recommendations",
    "rec.desc": "This page will show tailored recommendations based on your profile and selected field. We can add the full card layout when you’re ready.",
    "btn.back": "Back to Home",
  },
  hi: {
    brand: "पीएम इंटर्नशिप योजना",
    "landing.tagline": "जो इंटर्नशिप आपके लिए सबसे उपयुक्त हो उसे खोजें",
    "landing.cta": "मेरी इंटर्नशिप ढूँढें",
    "landing.desc": "टेक्नोलॉजी, वित्त, नीति, हेल्थकेयर और अधिक में चुन�� हुए अवसर। आपके प्रोफ़ाइल के अनुरूप।",
    "card.students.title": "विद्यार्थी",
    "card.students.sub": "स्नातक और परास्नातक के लिए",
    "card.tech.title": "टेक-रेडी",
    "card.tech.sub": "वास्तविक प्रभाव वाले प्रोजेक्ट्स",
    "card.offices.title": "ऑफिस और रिमोट",
    "card.offices.sub": "सरकारी और निजी भागीदार",

    "login.title": "लॉगिन / साइन अप",
    "field.fullname": "पूरा नाम",
    "ph.fullname": "अपना पूरा नाम लिखें",
    "field.age": "आयु",
    "ph.age": "18",
    "field.gender": "लिंग",
    "opt.gender.select": "चुनें",
    "opt.gender.male": "पुरुष",
    "opt.gender.female": "महिला",
    "opt.gender.other": "अन्य",
    "field.location": "स्थान",
    "ph.location": "शहर, राज्य",
    "field.phone": "फोन नंबर",
    "ph.phone": "+91 00000 00000",
    "field.aadhaar": "आधार नंबर",
    "ph.aadhaar": "XXXX-XXXX-XXXX",
    "field.email": "ईमेल (वैकल्पिक)",
    "ph.email": "you@example.com",
    "btn.verify": "सत्यापित करें और आगे बढ़ें",
    "btn.useLocation": "मेरा स्थान उपयोग करें",
    "loc.noResults": "कोई परिणाम नहीं",
    "loc.permissionDenied": "स्थान की अनुमति अस्वीकृत",

    "edu.title": "शिक्षा विवरण",
    "edu.10": "10वीं % / बोर्ड / वर्ष",
    "ph.edu.10": "उदा., 86% CBSE 2018",
    "edu.12": "12वीं % / बोर्ड / वर्ष",
    "ph.edu.12": "उदा., 90% CBSE 2020",
    "edu.ug": "यूजी डिग्री / शाखा / सीजीपीए",
    "ph.edu.ug": "उदा., B.Tech CSE 8.2",
    "edu.pg": "पीजी डिग्री / शाखा / सीजीपीए",
    "ph.edu.pg": "उदा., M.Tech AI 8.8",
    "edu.extra": "अतिरिक्त योग्यताएँ",
    "ph.edu.extra": "प्रमाणपत्र, पाठ्यक्रम आदि",
    "edu.resume": "रिज़्यूमे अपलोड कर���ं (PDF)",
    "edu.resume.hint": "केवल PDF, अधिकतम 5 एमबी",
    "btn.next": "आगे",

    "skills.title": "अपनी कौशल चुनें",
    "skills.addPlaceholder": "कस्टम कौशल जोड़ें",
    "skills.add": "जोड़ें",
    "skills.minAlert": "कम से कम एक कौशल चुनें।",
    "skills.js": "जावास्क्रिप्ट",
    "skills.py": "पायथन",
    "skills.data": "डेटा विश्लेषण",
    "skills.pm": "प्रोजेक्ट प्रबंधन",
    "skills.policy": "लोक नीति",
    "skills.health": "हेल्थकेयर",
    "skills.sustain": "स्थिरता",
    "skills.teach": "शिक्षण",
    "skills.hr": "मानव संसाधन",
    "skills.civil": "सिविल इंजीनियरिंग",
    "skills.rural": "ग्रामीण पहुंच",

    "btn.continue": "जारी रखें",

    "rec.title": "सिफारिशें",
    "rec.desc": "यह पेज आपकी प्रोफ़ाइल और चुने गए कौशल के आधार पर सिफारिशें दिखाएगा। हम पूर्ण कार्ड लेआउट जोड़ सकते हैं।",
    "btn.back": "होम पर वापस जाएँ",
  },
};

function t(lang, key){
  return (translations[lang] && translations[lang][key]) || translations.en[key] || key;
}

function applyTranslations(lang){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(!key) return;
    el.textContent = t(lang, key);
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    if(!key) return;
    el.setAttribute('placeholder', t(lang, key));
  });
  document.querySelectorAll('option[data-i18n]').forEach(opt=>{
    const key = opt.getAttribute('data-i18n');
    if(!key) return;
    opt.textContent = t(lang, key);
  });
}

function debounce(fn, delay){
  let id;
  return (...args)=>{ clearTimeout(id); id = setTimeout(()=>fn(...args), delay); };
}

function buildSuggestionLabel(item){
  if(item && item.address){
    const { city, town, village, state_district, state, county, country } = item.address;
    const parts = [city || town || village, state_district || state || county, country].filter(Boolean);
    return parts.join(", ");
  }
  return item.display_name || "";
}

document.addEventListener('DOMContentLoaded', ()=>{
  const langSel = document.getElementById('language');
  const current = sessionStorage.getItem('lang') || 'English';
  if(langSel){ langSel.value = current; }
  const resolved = (current === 'Hindi') ? 'hi' : 'en';
  applyTranslations(resolved);

  if(langSel){
    langSel.addEventListener('change', ()=>{
      sessionStorage.setItem('lang', langSel.value);
      const l = (langSel.value === 'Hindi') ? 'hi' : 'en';
      applyTranslations(l);
    });
  }

  // Education -> two-column already handled by HTML; nothing extra here.

  // Location autocomplete + geolocation on login page
  const locInput = document.getElementById('location');
  const useMyLocation = document.getElementById('use-my-location');
  const sugg = document.getElementById('location-suggestions');
  let activeIndex = -1;
  let items = [];
  let aborter = null;

  function hideSuggestions(){ if(sugg){ sugg.hidden = true; sugg.innerHTML=''; activeIndex=-1; items=[]; } }
  function renderSuggestions(list, lang){
    if(!sugg) return;
    sugg.innerHTML='';
    if(!list.length){
      const empty = document.createElement('div'); empty.className='suggestion-empty';
      empty.textContent = t(lang, 'loc.noResults'); sugg.appendChild(empty); sugg.hidden=false; return;
    }
    list.forEach((it, idx)=>{
      const div = document.createElement('div'); div.className='suggestion-item';
      div.textContent = buildSuggestionLabel(it);
      div.addEventListener('mousedown', (e)=>{ e.preventDefault(); selectSuggestion(idx); });
      sugg.appendChild(div);
    });
    sugg.hidden=false;
  }
  function updateActive(){ if(!sugg) return; Array.from(sugg.children).forEach((el,i)=> el.classList?.toggle('active', i===activeIndex)); }
  function selectSuggestion(idx){
    const it = items[idx]; if(!it) return;
    locInput.value = buildSuggestionLabel(it);
    hideSuggestions(); sessionStorage.setItem('locationLabel', locInput.value);
  }
  const fetchSuggestions = debounce(async (q)=>{
    if(!q || q.trim().length<2){ hideSuggestions(); return; }
    try{
      if(aborter){ aborter.abort(); }
      aborter = new AbortController();
      const langCode = (document.getElementById('language')?.value === 'Hindi') ? 'hi' : 'en';
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=6&accept-language=${langCode}`;
      const res = await fetch(url, { headers:{ 'Accept':'application/json','User-Agent':'PM-Internship-Scheme Demo' }, signal: aborter.signal });
      if(!res.ok) throw new Error('net');
      const data = await res.json(); items = Array.isArray(data)?data:[]; renderSuggestions(items, langCode);
    }catch(e){ if(e.name==='AbortError') return; hideSuggestions(); }
  }, 250);

  if(locInput){
    locInput.addEventListener('input', ()=> fetchSuggestions(locInput.value));
    locInput.addEventListener('keydown', (e)=>{
      if(sugg?.hidden) return; const max = items.length-1;
      if(e.key==='ArrowDown'){ e.preventDefault(); activeIndex = Math.min(max, activeIndex+1); updateActive(); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); activeIndex = Math.max(0, activeIndex-1); updateActive(); }
      else if(e.key==='Enter'){ if(activeIndex>=0){ e.preventDefault(); selectSuggestion(activeIndex); } }
      else if(e.key==='Escape'){ hideSuggestions(); }
    });
    document.addEventListener('click', (e)=>{ if(!sugg?.contains(e.target) && e.target!==locInput){ hideSuggestions(); } });
  }

  async function reverseGeocode(lat, lon){
    const langCode = (document.getElementById('language')?.value === 'Hindi') ? 'hi' : 'en';
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1&accept-language=${langCode}`;
    const res = await fetch(url, { headers:{ 'Accept':'application/json','User-Agent':'PM-Internship-Scheme Demo' } });
    if(!res.ok) throw new Error('net');
    const data = await res.json();
    return buildSuggestionLabel(data);
  }
  if(useMyLocation && locInput){
    useMyLocation.addEventListener('click', ()=>{
      if(!navigator.geolocation){ return alert('Geolocation not supported'); }
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        try{ const label = await reverseGeocode(pos.coords.latitude, pos.coords.longitude); locInput.value = label || ''; sessionStorage.setItem('locationLabel', locInput.value); }
        catch{ alert('Network error while detecting location'); }
      }, ()=>{ const langCode = (document.getElementById('language')?.value === 'Hindi') ? 'hi' : 'en'; alert(t(langCode, 'loc.permissionDenied')); }, { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
    });
  }

  // Skills page behavior (multi-select + custom skills)
  const skillsPage = document.getElementById('skills-page');
  if(skillsPage){
    const chipsWrap = document.getElementById('skills-chips');
    const selectedWrap = document.getElementById('skills-selected');
    const customInput = document.getElementById('custom-skill');
    const addBtn = document.getElementById('add-skill');
    const goBtn = document.getElementById('skills-continue');

    const selected = new Set(JSON.parse(sessionStorage.getItem('selectedSkills') || '[]'));

    function renderSelected(){
      if(!selectedWrap) return;
      selectedWrap.innerHTML = '';
      Array.from(selected).forEach(skill=>{
        const b = document.createElement('button');
        b.className = 'chip active'; b.type='button'; b.textContent = skill; b.dataset.skill = skill;
        b.addEventListener('click', ()=>{ selected.delete(skill); persist(); renderSelected(); markChips(); });
        selectedWrap.appendChild(b);
      });
    }
    function persist(){ sessionStorage.setItem('selectedSkills', JSON.stringify(Array.from(selected))); }
    function markChips(){
      chipsWrap?.querySelectorAll('.chip').forEach(ch=>{
        const s = ch.getAttribute('data-skill');
        if(!s) return;
        ch.classList.toggle('active', selected.has(s));
      });
    }

    chipsWrap?.addEventListener('click', (e)=>{
      const target = e.target.closest('.chip'); if(!target) return;
      const s = target.getAttribute('data-skill'); if(!s) return;
      if(selected.has(s)) selected.delete(s); else selected.add(s);
      persist(); markChips(); renderSelected();
    });

    addBtn?.addEventListener('click', ()=>{
      const val = (customInput?.value || '').trim(); if(!val) return;
      selected.add(val); customInput.value=''; persist(); renderSelected(); markChips();
    });

    renderSelected(); markChips();

    goBtn?.addEventListener('click', ()=>{
      if(selected.size === 0){
        const langCode = (document.getElementById('language')?.value === 'Hindi') ? 'hi' : 'en';
        alert(t(langCode, 'skills.minAlert'));
        return;
      }
      window.location.href = 'recommend.html';
    });
  }
});
